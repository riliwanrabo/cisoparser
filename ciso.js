import Main from "./dist/CISO.js";
import config from "./ciso8583/engine/postbridge-dataelement-config.json" assert { type: "json" };

// const baseMessage = require('./ciso8583/engine/dataelements.json')
// const baseSubFieldMessage = require('./ciso8583/engine/subField-data-elements.json')
import helpers from "./helpers.js";

const isoParserClass = new Main(config);
const isoParser = isoParserClass;

// sign on

const networkObject = {
  MTI: "0800",
  dataElement: {
    2: null,
    3: null,
    4: null,
    5: null,
    6: null,
    7: "0626203550",
    8: null,
    9: null,
    10: null,
    11: new Date().getTime().toString().substring(7),
    12: "203550",
    13: "0626",
    14: null,
    15: null,
    16: null,
    17: null,
    18: null,
    19: null,
    20: null,
    21: null,
    22: null,
    23: null,
    24: null,
    25: null,
    26: null,
    27: null,
    28: null,
    29: null,
    30: null,
    31: null,
    32: null,
    33: null,
    34: null,
    35: null,
    36: null,
    37: null,
    38: null,
    39: null,
    40: null,
    41: null,
    42: null,
    43: null,
    44: null,
    45: null,
    46: null,
    47: null,
    48: null,
    49: null,
    50: null,
    51: null,
    52: null,
    53: null,
    54: null,
    55: null,
    56: null,
    57: null,
    58: null,
    59: null,
    60: null,
    61: null,
    62: null,
    63: null,
    64: null,
    65: null,
    66: null,
    67: null,
    68: null,
    69: null,
    70: "301",
    71: null,
    72: null,
    73: null,
    74: null,
    75: null,
    76: null,
    77: null,
    78: null,
    79: null,
    80: null,
    81: null,
    82: null,
    83: null,
    84: null,
    85: null,
    86: null,
    87: null,
    88: null,
    89: null,
    90: null,
    91: null,
    92: null,
    93: null,
    94: null,
    95: null,
    96: null,
    97: null,
    98: null,
    99: null,
    100: null,
    101: null,
    102: null,
    103: null,
    104: null,
    105: null,
    106: null,
    107: null,
    108: null,
    109: null,
    110: null,
    111: null,
    112: null,
    113: null,
    114: null,
    115: null,
    116: null,
    117: null,
    118: null,
    119: null,
    120: null,
    121: null,
    122: null,
    123: null,
    124: null,
    125: null,
    126: null,
    127: null,
    128: null,
  },
};

const networkPackedMessageObject = isoParser.pack(
  networkObject.MTI,
  networkObject.dataElement
);

const networkStrLength = helpers.getAsciiLengthIndicator(
  networkPackedMessageObject.isoMessage.toString()
);

const networkIso = `${networkStrLength}${networkPackedMessageObject.isoMessage}`;
// console.log(networkIso);
// transaction
const xmlICC =
  "<IccData><IccRequest><AmountAuthorized>000000000051</AmountAuthorized><AmountOther>000000000000</AmountOther><ApplicationInterchangeProfile>3900</ApplicationInterchangeProfile><ApplicationTransactionCounter>0652</ApplicationTransactionCounter><Cryptogram>5BDAE286405034F5</Cryptogram><CryptogramInformationData>80</CryptogramInformationData><CvmResults>440302</CvmResults><IssuerApplicationData>0110A74003020000000000000000000000FF</IssuerApplicationData><TerminalCapabilities>E0F8C8</TerminalCapabilities><TerminalCountryCode>566</TerminalCountryCode><TerminalType>22</TerminalType><TerminalVerificationResult>0020001000</TerminalVerificationResult><TransactionCurrencyCode>566</TransactionCurrencyCode><TransactionDate>202300</TransactionDate><TransactionType>00</TransactionType><UnpredictableNumber>06355711</UnpredictableNumber></IccRequest></IccData>";
const hexXmlICC =
  "820239009F3602022D9F2701809F34034103029F10120110A50003020000000000000000000000FF9F330320E0808407A00000000410109F3501229F3704D699BF359F03060000000000009F02060000000100005F3401019F1A0205665F2A0205669C01009F26086E97861DB05A499F9A032308169F410400000003950580800088009F4104000000039F0607A00000000410109F1E083132333435363738";
const purchaseObject = {
  MTI: "0200",
  dataElement: {
    2: "5399834443762299",
    3: "010000",
    4: "000000040000",
    5: null,
    6: null,
    7: "0816041208",
    8: null,
    9: null,
    10: null,
    11: "005306",
    12: "040808",
    13: "0816",
    14: "2701",
    15: null,
    16: null,
    17: null,
    18: "4111",
    19: null,
    20: null,
    21: null,
    22: "051",
    23: "001",
    24: null,
    25: "00",
    26: "12",
    27: null,
    28: null,
    29: null,
    30: null,
    31: null,
    32: "000011",
    33: null,
    34: null,
    35: "5399834443762299D27012210016617128",
    36: "000000005290",
    37: "000000005411",
    38: null,
    39: null,
    40: "221",
    41: "2035BQS9",
    42: "2UP1LA000004414",
    43: "Osogbo MFB             LA           LANG",
    44: null,
    45: null,
    46: null,
    47: null,
    48: null,
    49: "566",
    50: null,
    51: null,
    52: null,
    53: null,
    54: null,
    55: null,
    56: "1510",
    57: null,
    58: null,
    59: null,
    60: null,
    61: null,
    62: null,
    63: null,
    64: null,
    65: null,
    66: null,
    67: null,
    68: null,
    69: null,
    70: null,
    71: null,
    72: null,
    73: null,
    74: null,
    75: null,
    76: null,
    77: null,
    78: null,
    79: null,
    80: null,
    81: null,
    82: null,
    83: null,
    84: null,
    85: null,
    86: null,
    87: null,
    88: null,
    89: null,
    90: null,
    91: null,
    92: null,
    93: null,
    94: null,
    95: null,
    96: null,
    97: null,
    98: null,
    99: null,
    100: null,
    101: null,
    102: null,
    103: "87001544",
    104: null,
    105: null,
    106: null,
    107: null,
    108: null,
    109: null,
    110: null,
    111: null,
    112: null,
    113: null,
    114: null,
    115: null,
    116: null,
    117: null,
    118: null,
    119: null,
    120: null,
    121: null,
    122: null,
    123: "510101511344101",
    124: null,
    125: null,
    126: null,
    127: null,
    128: null,
  },
};
const DE_127_2 = new Date().getTime().toString().substring(12, -1);
const DE_127_13 = "     000000   566";
let subFieldMessage = {
  MTI: null,
  dataElement: {
    2: DE_127_2,
    3: null,
    4: null,
    5: null,
    6: null,
    7: null,
    8: null,
    9: null,
    10: null,
    11: null,
    12: null,
    13: DE_127_13,
    14: null,
    15: null,
    16: null,
    17: null,
    18: null,
    19: null,
    20: null,
    21: null,
    22: null,
    23: null,
    24: null,
    25: xmlICC,
    26: null,
    27: null,
    28: null,
    29: null,
    30: null,
    31: null,
    32: null,
    33: null,
    34: null,
    35: null,
    36: null,
    37: null,
    38: null,
    39: null,
    40: null,
    41: null,
    42: null,
    43: null,
    44: null,
    45: null,
    46: null,
    47: null,
    48: null,
    49: null,
    50: null,
    51: null,
    52: null,
    53: null,
    54: null,
    55: null,
    56: null,
    57: null,
    58: null,
    59: null,
    60: null,
    61: null,
    62: null,
    63: null,
    64: null,
  },
};

let subIso = isoParser.packSubFieldWithHexadecimalBitmap(
  subFieldMessage.dataElement,
  config["127"].nestedElements
);

// console.log("sub iso message", subIso.isoMessage.toString());

purchaseObject.dataElement["127"] = subIso.isoMessage;

const purchasePackedMessageObject = isoParser.pack(
  purchaseObject.MTI,
  purchaseObject.dataElement
);

const purchaseStrlength = helpers.getAsciiLengthIndicator(
  purchasePackedMessageObject.isoMessage
);

console.log(`${purchaseStrlength}${purchasePackedMessageObject.isoMessage}`);
// console.log(purchasePackedMessageObject.isoMessage);

const _127message = isoParser.unpack(purchasePackedMessageObject.isoMessage);
Buffer.from(purchasePackedMessageObject.isoMessage);
// console.log("unpacked transaction", _127message.dataElements);

const packedIso = isoParser.pack(
  purchaseObject.MTI,
  purchaseObject.dataElement
);
const isoMessage = Buffer.from(packedIso.isoMessage);
const isoLength = isoMessage.toString("hex").length / 2;
const binLength = helpers.getLengthBytes(isoLength);
const requestISOMsg = Buffer.concat([binLength, isoMessage]);

console.log(requestISOMsg.toString());
